/*
 * jQuery TweetMachine v0.2.1b
 * GitHub: https://github.com/ryangiglio/jquery-tweetMachine
 * Copyright (c) 2013 Ryan Giglio (@ryangiglio)
 */(function(e){e.fn.tweetMachine=function(t,n,r){e(this).each(function(){var i,s;if(this.tweetMachine){i=e.extend(this.tweetMachine.settings,n);this.tweetMachine.settings=i;t&&(this.tweetMachine.query=t);this.tweetMachine.interval&&this.tweetMachine.refresh();r&&(this.tweetMachine.callback=r)}else{i=e.extend({backendScript:"ajax/getFromTwitter.php",endpoint:"search/tweets",user_name:"jason_alvis",include_retweets:!0,exclude_replies:!1,rate:5e3,limit:5,autoRefresh:!0,animateOut:!1,animateIn:!0,tweetFormat:"<li class='tweet'><img class='avatar' src=''/><div class='meta'><a href='' class='username'></a><a href='' class='time'></a></div><p class='content'></p></li>",localization:{seconds:"seconds ago",minute:"a minute ago",minutes:"minutes ago",hour:"an hour ago",hours:"hours ago",day:"a day ago",days:"days ago"},filter:!1},n);this.tweetMachine={settings:i,query:t,interval:!1,container:this,lastTweetID:null,callback:r,relativeTime:function(e){var t,n,r;n=Date.parse(e);t=(Date.parse(Date())-n)/1e3;r="";t<60?r=t+" "+i.localization.seconds:t<120?r=i.localization.minute:t<2700?r=parseInt(t/60,10).toString()+" "+i.localization.minutes:t<5400?r=i.localization.hour:t<86400?r=""+parseInt(t/3600,10).toString()+" "+i.localization.hours:t<172800?r=i.localization.day:r=parseInt(t/86400,10).toString()+" "+i.localization.days;return r},updateTimestamps:function(){var t;t=this;e(t.container).find(".time").each(function(){var n,r;r=e(this);n=r.data("timestamp");r.html(t.relativeTime(n))})},parseText:function(e){e=e.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"});e=e.replace(/@[A-Za-z0-9_]+/g,function(e){return'<a href="http://twitter.com/#!/'+e.replace(/^@/,"")+'" target="_blank">'+e+"</a>"});e=e.replace(/#[A-Za-z0-9_\-]+/g,function(e){return'<a href="http://twitter.com/#!/search?q='+e.replace(/^#/,"%23")+'" target="_blank">'+e+"</a>"});return e},buildTweet:function(t){var n,r;n=this;r=e(n.settings.tweetFormat);r.find(".avatar").attr("src",t.user.profile_image_url.replace("normal","reasonably_small"));r.find(".username").attr("href","http://twitter.com/"+t.user.screen_name).attr("target","_blank").html(""+t.user.screen_name);r.find(".time").attr("href","http://twitter.com/"+t.user.screen_name+"/status/"+t.id_str).attr("target","_blank").html(n.relativeTime(t.created_at)).data("timestamp",t.created_at);r.find(".content").html(n.parseText(t.text));n.settings.animateIn&&r.css("opacity","0");return r},refresh:function(t){var n,r;r=this;if(t||r.settings.autoRefresh){r.settings.endpoint==="search/tweets"&&(n={q:r.query,count:this.settings.requestLimit?this.settings.requestLimit:this.settings.limit,since_id:r.lastTweetID});r.settings.endpoint==="statuses/user_timeline"&&(n={screen_name:i.user_name,count:this.settings.requestLimit?this.settings.requestLimit:this.settings.limit,include_rts:i.include_retweets,exclude_replies:i.exclude_replies});e.getJSON(r.settings.backendScript,{endpoint:r.settings.endpoint,queryParams:n},function(n){var i;if(n[0])if(n[0].message)e(".twitter-error").length?e(".twitter-error").html('<p class="tweet-machine-error">Error  '+n[0].code+": "+n[0].message+"</p>"):e(r.container).before('<p class="twitter-error">Error  '+n[0].code+": "+n[0].message+"</p>");else{e(".twitter-error").length&&e(".twitter-error").remove();n.reverse();i=0;e.each(n,function(){var n,s;n=this;if(!r.settings.filter||r.settings.filter(this)){s=r.buildTweet(n);t||r.settings.animateOut||e(r.container).children(":last-child").remove();e(r.container).prepend(s);r.settings.animateIn&&e(r.container).children(":first-child").animate({opacity:1});i++;r.lastTweetID=n.id_str;if(i>r.settings.limit)return!1}})}if(typeof r.callback=="function"){if(typeof n=="undefined"||typeof i=="undefined"){n=null;i=0}r.callback(n,i)}})}},start:function(){var e;e=this;if(!this.interval){this.interval=setInterval(function(){e.refresh()},e.settings.rate);this.refresh(!0)}},stop:function(){var e;e=this;if(e.interval){clearInterval(e.interval);e.interval=!1}},clear:function(){var t;t=this;e(t.container).find(".tweet").remove();t.lastTweetID=null}};s=this.tweetMachine;this.timeInterval=setInterval(function(){s.updateTimestamps()},s.settings.rate);this.tweetMachine.start()}})}})(jQuery);